<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ابزار هوشمند یکپارچه تحلیل و تدوین فرایند</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
    <!-- Libraries for file processing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@2/dist/tesseract.min.js'></script>
    <style>
        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: #f3f4f6;
        }
        .main-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .card-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1f2937;
            border-bottom: 2px solid #6366f1;
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 700;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s;
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .btn-primary { background-color: #6366f1; }
        .btn-primary:hover { background-color: #4f46e5; }
        .btn-secondary { background-color: #10b981; }
        .btn-secondary:hover { background-color: #059669; }
        .btn-tertiary { background-color: #6b7280; }
        .btn-tertiary:hover { background-color: #4b5563; }
        .btn-green { background-color: #22c55e; }
        .btn-green:hover { background-color: #16a34a; }
        .btn-disabled { background-color: #d1d5db; cursor: not-allowed; }
        textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        textarea:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 2px #c7d2fe;
        }
        [contenteditable="true"] { background-color: #f0f9ff; outline: 2px dashed #90cdf4; outline-offset: 2px; cursor: text; padding: 4px; border-radius: 4px; min-height: 2rem; }
        [contenteditable="true"]:focus { background-color: #ffffff; outline: 2px solid #3b82f6; }
        .placeholder-text { color: #a0aec0; font-style: italic; }
        #output-container table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
            margin-bottom: 2rem;
            border: 2px solid #9ca3af;
        }
        #output-container th, #output-container td {
            border: 1px solid #d1d5db;
            padding: 0.5rem 0.75rem;
            text-align: right;
            vertical-align: top;
        }
        #output-container thead th {
            background-color: #f3f4f6;
            font-weight: 700;
            color: #374151;
        }
        #output-container .header-table th, #output-container .header-table td {
             border: 1px solid #d1d5db;
        }
        #output-container .section-title-cell {
            font-weight: bold;
            background-color: #e5e7eb;
            text-align: center;
            padding: 0.5rem;
            color: #1f2937;
        }
        #output-container caption {
            font-size: 1.1rem;
            font-weight: 700;
            text-align: right;
            padding: 0.5rem 0;
            margin-bottom: 0.5rem;
            color: #374151;
        }
        .loader-container {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            gap: 1rem;
            padding: 4rem 0;
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #6366f1;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            cursor: pointer;
            background-color: #f9fafb;
            border: 2px dashed #d1d5db;
            border-radius: 0.5rem;
            padding: 2rem;
            text-align: center;
            width: 100%;
        }
        .file-input-wrapper input[type=file] { position: absolute; left: 0; top: 0; opacity: 0; width: 100%; height: 100%; cursor: pointer; }
        .file-input-wrapper:hover { border-color: #6366f1; }
        .file-input-label { color: #6b7280; }
        #image-preview, #diagram-output img { max-width: 100%; border-radius: 0.5rem; margin-top: 1rem; }
        .modal-overlay { transition: opacity 0.3s ease; }
        .help-content h2 { font-size: 1.25rem; font-weight: bold; margin-top: 1.5rem; margin-bottom: 0.75rem; border-bottom: 1px solid #e2e8f0; padding-bottom: 0.25rem;}
        .help-content p { margin-bottom: 1rem; line-height: 1.7; }
        .help-content ul { list-style-type: disc; margin-right: 1.5rem; margin-bottom: 1rem; }
    </style>
</head>
<body class="p-4 sm:p-8">

    <!-- Login View -->
    <div id="login-view" class="min-h-screen flex items-center justify-center bg-gray-200 p-4">
        <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md text-right">
            <h2 class="text-2xl font-bold mb-6 text-center">ورود به ابزار تحلیل فرآیند</h2>
            <div class="space-y-4">
                <div>
                    <label for="user-name" class="block mb-2 font-semibold text-gray-700">نام و نام خانوادگی</label>
                    <input type="text" id="user-name" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="مثال: رضا اطیابی">
                </div>
                <div>
                    <label for="user-mobile" class="block mb-2 font-semibold text-gray-700">شماره موبایل</label>
                    <input type="text" id="user-mobile" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="مثال: 09123456789">
                </div>
                <div>
                    <label for="usage-code" class="block mb-2 font-semibold text-gray-700">کد استفاده</label>
                    <input type="text" id="usage-code" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="کد ۱۰ رقمی دریافتی را وارد کنید">
                </div>
                <button id="login-btn" class="w-full mt-4 bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700">ورود</button>
                <p id="login-error" class="text-red-500 text-sm text-center mt-2 hidden"></p>
            </div>
             <div class="mt-6 text-center text-sm">
                <a href="mailto:iamatyabi@gmail.com?subject=درخواست%20کد%20استفاده%20از%20ابزار%20تحلیل%20فرآیند" class="text-blue-600 hover:underline">درخواست کد استفاده</a>
            </div>
        </div>
    </div>

    <!-- App View -->
    <div id="app-view" class="hidden">
        <div class="max-w-4xl mx-auto">
            <header class="mb-8 flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="text-center md:text-right">
                    <h1 class="text-2xl md:text-3xl font-bold text-gray-800">ابزار هوشمند تحلیل و تدوین فرایند</h1>
                    <p id="user-welcome" class="text-gray-600 mt-2">خوش آمدید!</p>
                </div>
                <div class="flex items-center gap-2">
                    <div id="saved-reports-container" class="relative inline-block text-left">
                        <button id="saved-reports-btn" type="button" title="گزارش‌های ذخیره شده" class="inline-flex items-center justify-center w-10 h-10 rounded-md border border-gray-300 shadow-sm p-2 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" /></svg>
                        </button>
                        <div id="saved-reports-menu" class="origin-top-left absolute left-0 mt-2 w-72 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 hidden z-10">
                            <div id="saved-reports-list" class="py-1" role="menu" aria-orientation="vertical"></div>
                        </div>
                    </div>
                    <button id="help-btn" type="button" title="راهنما" class="inline-flex items-center justify-center w-10 h-10 rounded-md border border-gray-300 shadow-sm p-2 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    </button>
                </div>
            </header>

            <div class="main-container">
                <!-- Input Card -->
                <div id="input-card" class="card">
                    <h2 class="card-title">۱. ورود اطلاعات</h2>
                    <div class="mb-6">
                        <label class="block mb-2 font-bold text-gray-700">نوع تحلیل را انتخاب کنید:</label>
                        <div class="flex gap-4 rounded-lg bg-gray-100 p-1">
                            <label class="flex-1 text-center cursor-pointer">
                                <input type="radio" name="analysis-mode" value="spec" class="sr-only peer" checked>
                                <span class="block p-2 rounded-md peer-checked:bg-indigo-600 peer-checked:text-white">تدوین شناسنامه</span>
                            </label>
                            <label class="flex-1 text-center cursor-pointer">
                                <input type="radio" name="analysis-mode" value="bpr" class="sr-only peer">
                                <span class="block p-2 rounded-md peer-checked:bg-indigo-600 peer-checked:text-white">تحلیل بازمهندسی</span>
                            </label>
                        </div>
                    </div>
                    <div id="input-fields" class="space-y-6">
                        <div id="spec-inputs">
                            <div>
                                <label for="spec-text" class="block mb-2 font-bold text-gray-700">شرح کلی فرایند (متن جلسه، نمودار و...):</label>
                                <textarea id="spec-text" rows="8" class="text-sm" placeholder="شرح کامل فرایند، اهداف، مراحل و نکات مربوطه را در اینجا وارد کنید یا از طریق فایل بارگذاری نمایید..."></textarea>
                            </div>
                            <div>
                                <label for="spec-custom-data" class="block mb-2 font-bold text-gray-700">داده‌های اختصاصی سازمان (اختیاری):</label>
                                <textarea id="spec-custom-data" rows="4" class="text-sm" placeholder="برای کمک به هوش مصنوعی، لیست‌های اختصاصی سازمان را وارد کنید. مثال: &#10;اهداف استراتژیک: استقرار نظام جامع جذب، افزایش سهم بازار&#10;کلان فرایندها: مدیریت منابع انسانی، فروش و بازاریابی"></textarea>
                            </div>
                        </div>
                        <div id="bpr-inputs" class="hidden space-y-6">
                             <div>
                                <label for="bpr-spec" class="block mb-2 font-bold text-gray-700">شناسنامه و اطلاعات فرآیند:</label>
                                <textarea id="bpr-spec" rows="5" class="text-sm" placeholder="مثال: عنوان فرآیند: درخواست مرخصی.&#10;کد: HR-02..."></textarea>
                            </div>
                            <div>
                                <label for="bpr-meetings" class="block mb-2 font-bold text-gray-700">متن پیاده‌سازی شده جلسات:</label>
                                <textarea id="bpr-meetings" rows="5" class="text-sm" placeholder="مثال:&#10;آقای احمدی (فنی): فرم‌های کاغذی وقت‌گیر هستند..."></textarea>
                            </div>
                            <div>
                                <label for="bpr-experts" class="block mb-2 font-bold text-gray-700">تحلیل متخصصین:</label>
                                <textarea id="bpr-experts" rows="5" class="text-sm" placeholder="مثال:&#10;تحلیل مشاور: فرآیند به شدت دستی و وابسته به کاغذ است..."></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="mt-6">
                        <label class="block mb-2 font-bold text-gray-700">بارگذاری فایل (Word, PDF, تصویر):</label>
                        <div class="file-input-wrapper">
                            <input type="file" id="process-file" accept="image/*,.pdf,.doc,.docx">
                            <span class="file-input-label">برای انتخاب فایل کلیک کنید یا فایل را به اینجا بکشید</span>
                        </div>
                        <div class="mt-2 text-center">
                            <img id="image-preview" src="" alt="پیش‌نمایش تصویر" class="hidden mx-auto"/>
                            <span id="file-name" class="text-sm text-gray-500"></span>
                        </div>
                    </div>
                    <button id="generate-btn" class="btn btn-primary w-full mt-6">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2" viewBox="0 0 20 20" fill="currentColor"><path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v1h-2V4H7v1H5V4zM5 7h10v9a2 2 0 01-2 2H7a2 2 0 01-2-2V7z" /><path d="M11.707 12.293a1 1 0 010 1.414l-2 2a1 1 0 01-1.414-1.414l2-2a1 1 0 011.414 0z" /><path d="M12.707 10.293a1 1 0 011.414 0l2 2a1 1 0 01-1.414 1.414l-2-2a1 1 0 010-1.414z" /></svg>
                        تحلیل و تولید گزارش
                    </button>
                </div>

                <!-- Output Card -->
                <div id="output-card" class="card">
                    <h2 class="card-title">۲. خروجی تحلیل</h2>
                    <div id="output-container">
                        <div id="placeholder" class="text-center text-gray-500 py-16">
                            <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                            <p class="mt-4">گزارش پس از پردازش در اینجا نمایش داده می‌شود.</p>
                        </div>
                        <div id="loader-container" class="hidden loader-container">
                            <div class="loader"></div>
                            <p>در حال تحلیل هوشمند...</p>
                        </div>
                    </div>
                     <div id="action-buttons" class="mt-6 flex flex-col sm:flex-row gap-4 hidden">
                        <button id="save-report-btn" class="btn btn-green flex-1">ذخیره گزارش در مرورگر</button>
                        <button id="final-report-btn" class="btn btn-secondary flex-1">گزارش نهایی (PDF/HTML)</button>
                        <button id="copy-text-btn" class="btn btn-tertiary flex-1">کپی متن گزارش</button>
                    </div>
                </div>
            </div>

            <footer class="text-center mt-12 text-sm text-gray-500">
                <p>Tool created by: Reza Atyabi - iamatayabi@gmail.com</p>
            </footer>
        </div>
    </div>

    <!-- Help Modal -->
    <div id="help-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden modal-overlay">
        <div class="relative top-10 mx-auto p-5 border w-11/12 max-w-4xl shadow-lg rounded-md bg-white">
            <div class="mt-3 text-right">
                <div class="flex justify-between items-center border-b pb-3">
                    <h3 class="text-xl leading-6 font-medium text-gray-900">راهنمای ابزار هوشمند</h3>
                    <button id="close-help-btn" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <div id="help-content-container" class="mt-4 help-content max-h-[70vh] overflow-y-auto pr-2"></div>
            </div>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const loginView = document.getElementById('login-view');
        const appView = document.getElementById('app-view');
        const loginBtn = document.getElementById('login-btn');
        const userNameInput = document.getElementById('user-name');
        const userMobileInput = document.getElementById('user-mobile');
        const usageCodeInput = document.getElementById('usage-code');
        const loginError = document.getElementById('login-error');
        const userWelcome = document.getElementById('user-welcome');
        
        const generateBtn = document.getElementById('generate-btn');
        const processFileInput = document.getElementById('process-file');
        const outputContainer = document.getElementById('output-container');
        const loaderContainer = document.getElementById('loader-container');
        const placeholder = document.getElementById('placeholder');
        const actionButtons = document.getElementById('action-buttons');
        const saveReportBtn = document.getElementById('save-report-btn');
        const finalReportBtn = document.getElementById('final-report-btn');
        const copyTextBtn = document.getElementById('copy-text-btn');
        const imagePreview = document.getElementById('image-preview');
        const fileNameSpan = document.getElementById('file-name');
        const helpBtn = document.getElementById('help-btn');
        const helpModal = document.getElementById('help-modal');
        const closeHelpBtn = document.getElementById('close-help-btn');
        const helpContentContainer = document.getElementById('help-content-container');
        const modeRadios = document.querySelectorAll('input[name="analysis-mode"]');
        const savedReportsBtn = document.getElementById('saved-reports-btn');
        const savedReportsMenu = document.getElementById('saved-reports-menu');
        const savedReportsList = document.getElementById('saved-reports-list');
        
        let imageBase64 = null;
        let diagramImageSrc = null;
        let currentUser = null;
        const validCodes = ["A5B1C9D8E2", "F4G7H3J1K6", "L2M8N5P3Q9", "R7S4T1U6V2", "W8X3Y9Z5A1"];

        // --- Setup Libraries ---
        if (window.pdfjsLib) {
            pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js`;
        }

        // --- Authentication & Session ---
        loginBtn.addEventListener('click', () => {
            const name = userNameInput.value.trim();
            const mobile = userMobileInput.value.trim();
            const code = usageCodeInput.value.trim();

            if (!name || !mobile || !code) {
                loginError.textContent = 'لطفاً تمام فیلدها را تکمیل کنید.';
                loginError.classList.remove('hidden');
                return;
            }
            if (!validCodes.includes(code)) {
                loginError.textContent = 'کد استفاده نامعتبر است.';
                loginError.classList.remove('hidden');
                return;
            }
            
            loginError.classList.add('hidden');
            currentUser = { name, mobile, code };
            localStorage.setItem('bprCurrentUser', JSON.stringify(currentUser));
            initializeApp();
        });
        
        window.addEventListener('load', () => {
            const savedUser = localStorage.getItem('bprCurrentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                initializeApp();
            }
        });

        function initializeApp() {
            loginView.classList.add('hidden');
            appView.classList.remove('hidden');
            userWelcome.textContent = `${currentUser.name}، خوش آمدید!`;
            loadSavedReports();
        }

        // --- Saved Reports Logic ---
        savedReportsBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            savedReportsMenu.classList.toggle('hidden');
        });
        document.addEventListener('click', () => savedReportsMenu.classList.add('hidden'));

        function loadSavedReports() {
            if (!currentUser) return;
            const reportsKey = `bprReports_${currentUser.code}`;
            const reports = JSON.parse(localStorage.getItem(reportsKey) || '[]');
            
            savedReportsList.innerHTML = ''; 
            if (reports.length === 0) {
                 savedReportsList.innerHTML = '<p class="px-4 py-2 text-xs text-gray-500">گزارشی یافت نشد.</p>';
            } else {
                reports.forEach((report) => {
                    const reportItem = document.createElement('div');
                    reportItem.className = 'flex items-center justify-between px-4 py-2 text-sm text-gray-700 hover:bg-gray-100';
                    const reportLink = document.createElement('a');
                    reportLink.href = '#';
                    reportLink.className = 'flex-grow';
                    reportLink.innerHTML = `<span class="font-semibold">${report.title}</span><br><span class="text-xs text-gray-500">${new Date(report.timestamp).toLocaleDateString('fa-IR')}</span>`;
                    reportLink.onclick = (e) => {
                        e.preventDefault();
                        outputContainer.innerHTML = report.htmlContent;
                        diagramImageSrc = report.diagramImageSrc; // Restore diagram
                        actionButtons.classList.remove('hidden');
                        savedReportsMenu.classList.add('hidden');
                    };
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'text-red-500 hover:text-red-700 p-1 mr-2';
                    deleteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>`;
                    deleteBtn.onclick = (e) => { e.stopPropagation(); deleteReport(report.timestamp); };
                    reportItem.appendChild(reportLink);
                    reportItem.appendChild(deleteBtn);
                    savedReportsList.appendChild(reportItem);
                });
            }
        }

        function deleteReport(timestamp) {
            if (!currentUser || !confirm('آیا از حذف این گزارش اطمینان دارید؟')) return;
            const reportsKey = `bprReports_${currentUser.code}`;
            let reports = JSON.parse(localStorage.getItem(reportsKey) || '[]');
            reports = reports.filter(report => report.timestamp !== timestamp);
            localStorage.setItem(reportsKey, JSON.stringify(reports));
            loadSavedReports();
        }
        
        saveReportBtn.addEventListener('click', () => {
            if (!currentUser) return;
            const reportsKey = `bprReports_${currentUser.code}`;
            const reports = JSON.parse(localStorage.getItem(reportsKey) || '[]');
            const titleEl = outputContainer.querySelector('.header-table td:nth-child(2), caption');
            const reportName = titleEl ? titleEl.innerText.trim() : 'گزارش بدون نام';
            
            reports.unshift({
                title: reportName,
                htmlContent: outputContainer.innerHTML,
                diagramImageSrc: diagramImageSrc,
                timestamp: new Date().toISOString()
            });
            localStorage.setItem(reportsKey, JSON.stringify(reports));
            alert('گزارش با موفقیت در این مرورگر ذخیره شد!');
            loadSavedReports();
        });


        // --- Mode Switching Logic ---
        modeRadios.forEach(radio => {
            radio.addEventListener('change', (e) => {
                const mode = e.target.value;
                document.getElementById('spec-inputs').classList.toggle('hidden', mode !== 'spec');
                document.getElementById('bpr-inputs').classList.toggle('hidden', mode !== 'bpr');
            });
        });
        
        // --- File Processing Logic ---
        processFileInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            fileNameSpan.textContent = `در حال پردازش: ${file.name}...`;
            imagePreview.classList.add('hidden');
            imagePreview.src = '';
            imageBase64 = null;
            diagramImageSrc = null;
            
            const fileType = file.type;
            const fileName = file.name.toLowerCase();

            try {
                if (fileType.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const dataUrl = e.target.result;
                        imagePreview.src = dataUrl;
                        diagramImageSrc = dataUrl;
                        imagePreview.classList.remove('hidden');
                        imageBase64 = dataUrl.split(',')[1];
                        fileNameSpan.textContent = file.name;
                    };
                    reader.readAsDataURL(file);
                    
                    const worker = await Tesseract.createWorker('fas');
                    const { data: { text: ocrText } } = await worker.recognize(file);
                    getActiveTextarea().value += '\n' + ocrText;
                    await worker.terminate();
                } else {
                    let text = '';
                    if (fileName.endsWith('.pdf')) {
                        const arrayBuffer = await file.arrayBuffer();
                        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                        for (let i = 1; i <= pdf.numPages; i++) {
                            const page = await pdf.getPage(i);
                            const textContent = await page.getTextContent();
                            text += textContent.items.map(item => item.str).join(' ') + '\n';
                        }
                    } else if (fileName.endsWith('.docx')) {
                        const arrayBuffer = await file.arrayBuffer();
                        const result = await mammoth.extractRawText({ arrayBuffer });
                        text = result.value;
                    } else {
                        throw new Error('فرمت فایل پشتیبانی نمی‌شود.');
                    }
                    getActiveTextarea().value = text;
                    fileNameSpan.textContent = `متن از ${file.name} استخراج شد.`;
                }
            } catch (err) {
                alert(`خطا در پردازش فایل: ${err.message}`);
                fileNameSpan.textContent = `خطا در خواندن فایل.`;
                console.error(err);
            } finally {
                processFileInput.value = '';
            }
        });

        function getActiveTextarea() {
            const currentMode = document.querySelector('input[name="analysis-mode"]:checked').value;
            return currentMode === 'spec' ? document.getElementById('spec-text') : document.getElementById('bpr-spec');
        }

        // --- Main Analysis Logic ---
        generateBtn.addEventListener('click', async () => {
            const mode = document.querySelector('input[name="analysis-mode"]:checked').value;
            let prompt = '';
            let hasContent = false;

            if (mode === 'spec') {
                const processText = document.getElementById('spec-text').value.trim();
                const customData = document.getElementById('spec-custom-data').value.trim();
                if (processText || imageBase64) {
                    hasContent = true;
                    prompt = buildSpecPrompt(processText, customData);
                }
            } else { // bpr mode
                const bprSpec = document.getElementById('bpr-spec').value.trim();
                const bprMeetings = document.getElementById('bpr-meetings').value.trim();
                const bprExperts = document.getElementById('bpr-experts').value.trim();
                if (bprSpec || bprMeetings || bprExperts || imageBase64) {
                    hasContent = true;
                    prompt = buildBprPrompt(bprSpec, bprMeetings, bprExperts);
                }
            }

            if (!hasContent) {
                alert('لطفاً حداقل یکی از بخش‌های ورودی را تکمیل یا فایلی را بارگذاری کنید.');
                return;
            }
            
            showLoading(true);

            try {
                const result = await callGeminiAPI(prompt, imageBase64, mode);
                if (result && result.candidates && result.candidates.length > 0) {
                    const content = result.candidates[0].content.parts[0].text;
                    const processData = JSON.parse(content);
                    renderOutput(processData, mode);
                } else {
                    handleError("پاسخ معتبری از سرویس دریافت نشد. لطفاً دوباره تلاش کنید.");
                }
            } catch (error) {
                console.error('Error:', error);
                handleError(`خطا در پردازش: ${error.message}. ممکن است پاسخ سرویس در فرمت مورد انتظار نباشد.`);
            } finally {
                showLoading(false);
            }
        });

        // --- Prompt Builders ---
        function buildSpecPrompt(processText, customData) {
            return `
                You are an expert Business Process Management (BPM) analyst. Your task is to analyze the provided information and generate a structured process specification in JSON format, exactly matching the requested schema.
                **Inputs**:
                1. Process Description/Image/Meeting Transcript: ${processText}
                2. Organizational Context (Custom Lists): ${customData}
                **Task**: Based on all inputs, fill out the JSON schema for a process specification. Use the field descriptions in the schema as a guide for what to extract. Infer details logically. For 'processTitle', try to follow the format: Verb + Customer + Scope. For 'processType', choose from: اصلی, پشتیبانی, مدیریتی. For 'macroProcess' and 'processGroup', use the provided custom data or standard APQC levels if applicable.
            `;
        }

        function buildBprPrompt(spec, meetings, experts) {
            return `
                You are an expert Business Process Re-engineering (BPR) consultant. Your task is to analyze the provided information and generate a structured BPR analysis report in JSON format.
                **Inputs**:
                1. Process Specification (Main subject): ${spec}
                2. Meeting Notes: ${meetings || 'Not provided.'}
                3. Expert Analysis: ${experts || 'Not provided.'}
                **Task**: Based on all inputs, fill out the JSON schema for a BPR report. The output must include tables for components analysis, indicators, and solutions, matching the schema structure.
            `;
        }

        // --- API Call ---
        async function callGeminiAPI(prompt, base64ImageData, mode) {
            const apiKey = ""; // The environment will provide the key
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            let parts = [{ text: prompt }];
            if (base64ImageData) {
                parts.push({
                    inlineData: {
                        mimeType: "image/jpeg",
                        data: base64ImageData
                    }
                });
            }

            const payload = {
                contents: [{ role: "user", parts: parts }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: mode === 'spec' ? getSpecSchema() : getBprSchema()
                }
            };
            
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error(`API call failed with status: ${response.status}`);
            }
            return response.json();
        }

        // --- JSON Schemas for API ---
        function getSpecSchema() {
            return {
                type: "OBJECT",
                properties: {
                    companyName: { type: "STRING", description: "نام سازمان یا شرکت" },
                    processCode: { type: "STRING", description: "کد فرایند که فرایند" },
                    revisionNumber: { type: "STRING", description: "آخرین شماره بازنگری" },
                    revisionDate: { type: "STRING", description: "تاریخ آخرین بازنگری" },
                    processTitle: { type: "STRING", description: "عنوان فرایند (فعل + مشتری فرایند + دامنه کاربرد در بخش های سازمان)" },
                    processOwner: { type: "STRING", description: "مالک فرایند (واحد یا نقش سازمانی مالک)" },
                    processSupervisor: { type: "STRING", description: "ناظر فرایند (واحد یا نقش سازمانی ناظر)" },
                    stakeholders: { type: "STRING", description: "ذینفعان فرایند (مشتریان یا تاثیر پذیران از فرایند)" },
                    processType: { type: "STRING", description: "نوع فرایند (اصلی، پشتیبانی، مدیریتی)" },
                    strategicGoals: { type: "STRING", description: "اهداف استراتژیک مرتبط (انتخاب از لیست اهداف استراتژیک تعریف شده در سازمان)" },
                    processDescription: { type: "STRING", description: "شرح فرایند (عنوان فرایند + مراحل اصلی فرایند + هدف فرایند + خروجی مورد انتظار)" },
                    scope: { type: "STRING", description: "دامنه کاربرد (مشتریان فرایند + شروع فرایند + پایان فرایند)" },
                    macroProcess: { type: "STRING", description: "کلان فرایند (انتخاب از دسته بندی تعریف شده یا دسته بندی APQC سطح ۲)" },
                    processGroup: { type: "STRING", description: "گروه فرایند (انتخاب از دسته بندی تعریف شده یا دسته بندی APQC سطح ۳)" },
                    infoResources: { type: "STRING", description: "منابع اطلاعاتی (عنوان تیتروار منابع بانکها و سیستم های اطلاعاتی)" },
                    software: { type: "STRING", description: "نرم افزار / سیستم (عنوان تیتر وار نرم افزارها سامانه ها و سیستم ها)" },
                    hardware: { type: "STRING", description: "سخت افزار (سخت افزار اداری و صنعتی مورد استفاده در فرایند)" },
                    io: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                sourceProcess: { type: "STRING", description: "فرایند مبدا / فرستنده" },
                                input: { type: "STRING", description: "ورودی فرایند از جنس مختلف (پیام، اطلاعات، محرک زمانی، دستور)" },
                                output: { type: "STRING", description: "خروجی فرایند از جنس مختلف" },
                                destinationProcess: { type: "STRING", description: "فرایند مقصد / گیرنده" }
                            }
                        }
                    },
                    kpis: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                description: { type: "STRING", description: "شرح و نحوه محاسبه شاخص (موجود یا پیشنهادی)" },
                                acceptanceCriteria: { type: "STRING", description: "حداقل میزان قابل قبول شاخص" },
                                responsible: { type: "STRING", description: "واحد سازمانی مسئول پایش و اندازه گیری" },
                                period: { type: "STRING", description: "دوره زمانی پایش و اندازه گیری" }
                            }
                        }
                    },
                    revisions: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                revNumber: { type: "STRING" },
                                revDate: { type: "STRING" },
                                description: { type: "STRING", description: "شرح بازنگری انجام شده در یک خط" }
                            }
                        }
                    },
                    approvals: {
                        type: "OBJECT",
                        properties: {
                            preparers: { type: "ARRAY", items: { type: "OBJECT", properties: { name: { type: "STRING" }, title: { type: "STRING" } } } },
                            reviewers: { type: "ARRAY", items: { type: "OBJECT", properties: { name: { type: "STRING" }, title: { type: "STRING" } } } },
                            approver: { type: "OBJECT", properties: { name: { type: "STRING" }, title: { type: "STRING" } } }
                        }
                    }
                }
            };
        }

        function getBprSchema() {
            return {
                type: "OBJECT",
                properties: {
                    processTitle: { type: "STRING", nullable: true },
                    processCode: { type: "STRING", nullable: true },
                    componentsAnalysis: {
                        type: "ARRAY", nullable: true,
                        items: { type: "OBJECT", properties: { component: { type: "STRING" }, currentState: { type: "STRING" }, desiredState: { type: "STRING" } } }
                    },
                    indicators: {
                        type: "ARRAY", nullable: true,
                        items: { type: "OBJECT", properties: { title: { type: "STRING" }, acceptanceCriteria: { type: "STRING" }, monitoringPeriod: { type: "STRING" }, value: { type: "STRING" } } }
                    },
                    solutions: {
                        type: "ARRAY", nullable: true,
                        items: { type: "OBJECT", properties: { problemTitle: { type: "STRING" }, improvementAction: { type: "STRING" }, responsible: { type: "STRING" }, deadline: { type: "STRING" } } }
                    }
                }
            };
        }

        // --- Rendering Logic ---
        function renderOutput(data, mode) {
            outputContainer.innerHTML = '';
            if (mode === 'spec') {
                renderSpecificationReport(data);
            } else {
                renderBprReport(data);
            }
            actionButtons.classList.remove('hidden');
        }

        function createEditableCell(content) {
            const cell = document.createElement('td');
            const div = document.createElement('div');
            div.setAttribute('contenteditable', 'true');
            if (content && content.trim()) {
                div.innerText = content;
            } else {
                div.innerHTML = `<span class="placeholder-text">جهت تکمیل کلیک کنید</span>`;
                div.onfocus = () => { if (div.querySelector('.placeholder-text')) { div.innerHTML = ''; } };
                div.onblur = () => { if (div.innerText.trim() === '') { div.innerHTML = `<span class="placeholder-text">جهت تکمیل کلیک کنید</span>`; } };
            }
            cell.appendChild(div);
            return cell;
        }

        function renderSpecificationReport(data) {
            const d = (val) => val || '';
            const headerTable = document.createElement('table');
            headerTable.className = 'header-table';
            headerTable.innerHTML = `
                <tr>
                    <td rowspan="2" class="w-1/4 text-center font-bold">${d(data.companyName)}</td>
                    <td rowspan="2" class="w-1/2 text-center font-bold text-lg">شناسنامه فرایند</td>
                    <td class="w-1/4"></td>
                </tr>
                <tr><td></td></tr>`;
            headerTable.rows[0].cells[2].appendChild(createEditableCell(data.processCode).firstElementChild);
            headerTable.rows[1].cells[0].innerHTML = `شماره بازنگری: ${d(data.revisionNumber)} &nbsp;&nbsp; تاریخ: ${d(data.revisionDate)}`;
            
            const mainInfoTable = document.createElement('table');
            mainInfoTable.innerHTML = `
                <tr><td colspan="4" class="section-title-cell">اطلاعات کلی</td></tr>
                <tr><th class="w-1/6">عنوان فرایند</th><td colspan="3"></td></tr>
                <tr><th>مالک فرایند</th><td></td><th>ناظر فرایند</th><td></td></tr>
                <tr><th>ذینفعان فرایند</th><td></td><th>نوع فرایند</th><td></td></tr>
                <tr><th>اهداف استراتژیک مرتبط</th><td colspan="3"></td></tr>`;
            mainInfoTable.rows[1].cells[1].appendChild(createEditableCell(data.processTitle).firstElementChild);
            mainInfoTable.rows[2].cells[1].appendChild(createEditableCell(data.processOwner).firstElementChild);
            mainInfoTable.rows[2].cells[3].appendChild(createEditableCell(data.processSupervisor).firstElementChild);
            mainInfoTable.rows[3].cells[1].appendChild(createEditableCell(data.stakeholders).firstElementChild);
            mainInfoTable.rows[3].cells[3].appendChild(createEditableCell(data.processType).firstElementChild);
            mainInfoTable.rows[4].cells[1].appendChild(createEditableCell(data.strategicGoals).firstElementChild);

            const positionTable = document.createElement('table');
            positionTable.innerHTML = `
                <tr><td colspan="4" class="section-title-cell">جایگاه</td></tr>
                <tr><th>شرح فرایند</th><td colspan="3"></td></tr>
                <tr><th>دامنه کاربرد</th><td colspan="3"></td></tr>
                <tr><th>کلان فرایند</th><td></td><th>گروه فرایند</th><td></td></tr>`;
            positionTable.rows[1].cells[1].appendChild(createEditableCell(data.processDescription).firstElementChild);
            positionTable.rows[2].cells[1].appendChild(createEditableCell(data.scope).firstElementChild);
            positionTable.rows[3].cells[1].appendChild(createEditableCell(data.macroProcess).firstElementChild);
            positionTable.rows[3].cells[3].appendChild(createEditableCell(data.processGroup).firstElementChild);

            const resourcesTable = document.createElement('table');
            resourcesTable.innerHTML = `
                <tr><td colspan="2" class="section-title-cell">منابع و سیستم</td></tr>
                <tr><th class="w-1/4">منابع اطلاعاتی</th><td></td></tr>
                <tr><th>نرم افزار / سیستم</th><td></td></tr>
                <tr><th>سخت افزار</th><td></td></tr>`;
            resourcesTable.rows[1].cells[1].appendChild(createEditableCell(data.infoResources).firstElementChild);
            resourcesTable.rows[2].cells[1].appendChild(createEditableCell(data.software).firstElementChild);
            resourcesTable.rows[3].cells[1].appendChild(createEditableCell(data.hardware).firstElementChild);

            const ioTable = document.createElement('table');
            ioTable.innerHTML = `
                <tr><td colspan="5" class="section-title-cell">ورودی / خروجی فرایند</td></tr>
                <thead><tr><th class="w-8">ردیف</th><th>فرایند مبدا / فرستنده</th><th>ورودی</th><th>خروجی</th><th>فرایند مقصد / گیرنده</th></tr></thead>
                <tbody></tbody>`;
            const ioTbody = ioTable.querySelector('tbody');
            if (data.io && data.io.length > 0) {
                data.io.forEach((item, index) => {
                    const row = ioTbody.insertRow();
                    row.insertCell().textContent = index + 1;
                    row.appendChild(createEditableCell(item.sourceProcess));
                    row.appendChild(createEditableCell(item.input));
                    row.appendChild(createEditableCell(item.output));
                    row.appendChild(createEditableCell(item.destinationProcess));
                });
            } else { ioTbody.innerHTML = '<tr><td colspan="5" class="text-center text-gray-500">موردی یافت نشد</td></tr>'; }

            const kpiTable = document.createElement('table');
            kpiTable.innerHTML = `
                <tr><td colspan="5" class="section-title-cell">شاخص های فرایند</td></tr>
                <thead><tr><th class="w-8">ردیف</th><th>شرح شاخص</th><th>معیار پذیرش</th><th>مسئول پایش</th><th>دوره پایش</th></tr></thead>
                <tbody></tbody>`;
            const kpiTbody = kpiTable.querySelector('tbody');
            if (data.kpis && data.kpis.length > 0) {
                data.kpis.forEach((item, index) => {
                    const row = kpiTbody.insertRow();
                    row.insertCell().textContent = index + 1;
                    row.appendChild(createEditableCell(item.description));
                    row.appendChild(createEditableCell(item.acceptanceCriteria));
                    row.appendChild(createEditableCell(item.responsible));
                    row.appendChild(createEditableCell(item.period));
                });
            } else { kpiTbody.innerHTML = '<tr><td colspan="5" class="text-center text-gray-500">موردی یافت نشد</td></tr>'; }

            const revisionTable = document.createElement('table');
            revisionTable.innerHTML = `
                <tr><td colspan="3" class="section-title-cell">سوابق بازنگری</td></tr>
                <thead><tr><th class="w-1/4">شماره بازنگری</th><th class="w-1/4">تاریخ بازنگری</th><th>توضیحات</th></tr></thead>
                <tbody></tbody>`;
            const revTbody = revisionTable.querySelector('tbody');
            if (data.revisions && data.revisions.length > 0) {
                data.revisions.forEach(item => {
                    const row = revTbody.insertRow();
                    row.appendChild(createEditableCell(item.revNumber));
                    row.appendChild(createEditableCell(item.revDate));
                    row.appendChild(createEditableCell(item.description));
                });
            } else { revTbody.innerHTML = '<tr><td colspan="3" class="text-center text-gray-500">موردی یافت نشد</td></tr>'; }

            const approvalTable = document.createElement('table');
            const approvals = data.approvals || {};
            const preparers = (approvals.preparers || []).map(p => `${d(p.name)} (${d(p.title)})`).join('\n');
            const reviewers = (approvals.reviewers || []).map(p => `${d(p.name)} (${d(p.title)})`).join('\n');
            const approver = approvals.approver ? `${d(approvals.approver.name)} (${d(approvals.approver.title)})` : '';
            approvalTable.innerHTML = `
                <tr class="text-center font-bold"><td>تهیه کنندگان</td><td>تایید کنندگان</td><td>تصویب کننده</td></tr>
                <tr class="h-24 align-top">
                    <td><div contenteditable="true" style="white-space: pre-wrap;">${preparers}</div></td>
                    <td><div contenteditable="true" style="white-space: pre-wrap;">${reviewers}</div></td>
                    <td><div contenteditable="true" style="white-space: pre-wrap;">${approver}</div></td>
                </tr>`;

            const diagramSection = diagramImageSrc ? `<div id="diagram-output" class="mt-8"><h2>نمودار فرآیند (BPMN)</h2><img src="${diagramImageSrc}" alt="نمودار فرایند" /></div>` : '';

            outputContainer.append(headerTable, mainInfoTable, positionTable, resourcesTable, ioTable, kpiTable, revisionTable, approvalTable);
            if(diagramImageSrc) outputContainer.insertAdjacentHTML('beforeend', diagramSection);
        }

        function renderBprReport(data) {
            // This function remains unchanged
            if (data.processTitle || data.processCode) {
                const infoTable = document.createElement('table');
                infoTable.innerHTML = `
                    <caption>اطلاعات کلی فرآیند</caption>
                    <tbody>
                        <tr><th class="w-1/4">عنوان فرآیند</th><td>${data.processTitle || ''}</td></tr>
                        <tr><th class="w-1/4">کد فرآیند</th><td>${data.processCode || ''}</td></tr>
                    </tbody>`;
                outputContainer.appendChild(infoTable);
            }
            if (data.componentsAnalysis && data.componentsAnalysis.length > 0) {
                const table = document.createElement('table');
                table.innerHTML = `<caption>جدول تحلیل مولفه‌ها</caption><thead><tr><th class="w-8">ردیف</th><th>مولفه تحلیل</th><th>وضعیت موجود</th><th>وضعیت مطلوب</th></tr></thead><tbody></tbody>`;
                const tbody = table.querySelector('tbody');
                data.componentsAnalysis.forEach((item, index) => {
                    tbody.innerHTML += `<tr><td class="text-center">${index + 1}</td><td>${item.component}</td><td>${item.currentState}</td><td>${item.desiredState}</td></tr>`;
                });
                outputContainer.appendChild(table);
            }
            if (data.indicators && data.indicators.length > 0) {
                const table = document.createElement('table');
                table.innerHTML = `<caption>جدول شاخص‌های پایش</caption><thead><tr><th class="w-8">ردیف</th><th>شاخص</th><th>معیار پذیرش</th><th>دوره پایش</th><th>مقدار</th></tr></thead><tbody></tbody>`;
                const tbody = table.querySelector('tbody');
                data.indicators.forEach((item, index) => {
                    tbody.innerHTML += `<tr><td class="text-center">${index + 1}</td><td>${item.title}</td><td>${item.acceptanceCriteria}</td><td>${item.monitoringPeriod}</td><td>${item.value}</td></tr>`;
                });
                outputContainer.appendChild(table);
            }
            if (data.solutions && data.solutions.length > 0) {
                const table = document.createElement('table');
                table.innerHTML = `<caption>جدول مشکلات و راهکارها</caption><thead><tr><th class="w-8">ردیف</th><th>مشکل</th><th>راهکار اجرایی</th><th>مسئول</th><th>مهلت</th></tr></thead><tbody></tbody>`;
                const tbody = table.querySelector('tbody');
                data.solutions.forEach((item, index) => {
                    tbody.innerHTML += `<tr><td class="text-center">${index + 1}</td><td>${item.problemTitle}</td><td>${item.improvementAction}</td><td>${item.responsible}</td><td>${item.deadline}</td></tr>`;
                });
                outputContainer.appendChild(table);
            }
        }
        
        // --- UI Helpers ---
        function handleError(message) {
            outputContainer.innerHTML = `<div class="text-center text-red-600 p-8">${message}</div>`;
        }

        function showLoading(isLoading) {
            loader.classList.toggle('hidden', !isLoading);
            placeholder.classList.toggle('hidden', isLoading);
            if(isLoading) outputContainer.innerHTML = '';
            actionButtons.classList.add('hidden');
            generateBtn.disabled = isLoading;
            generateBtn.classList.toggle('btn-disabled', isLoading);
        }
        
        // --- Action Buttons Logic ---
        finalReportBtn.addEventListener('click', () => {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = outputContainer.innerHTML;
            tempDiv.querySelectorAll('[contenteditable="true"]').forEach(el => {
                if (el.querySelector('.placeholder-text')) {
                    el.innerHTML = '';
                }
                el.removeAttribute('contenteditable');
            });
            const reportContent = tempDiv.innerHTML;
            const reportTitle = outputContainer.querySelector('.header-table td:nth-child(2)')?.textContent || 'گزارش تحلیل فرایند';
            const newWindow = window.open('', '', 'width=800,height=600');
            const finalHtml = `
                <html>
                    <head>
                        <title>${reportTitle}</title>
                        <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
                        <style>
                            body { font-family: 'Vazirmatn', sans-serif; direction: rtl; padding: 1rem; font-size: 14px; }
                            table { border-collapse: collapse; width: 100%; margin-bottom: 1.5rem; }
                            th, td { border: 1px solid #ccc; padding: 6px 8px; text-align: right; vertical-align: top; }
                            thead th, .section-title-cell { background-color: #e5e7eb; font-weight: bold; }
                            .section-title-cell { text-align: center; }
                            .no-print { text-align: left; margin-bottom: 1rem; }
                            #diagram-output img { max-width: 100%; page-break-before: always; }
                            @media print { .no-print { display: none; } }
                        </style>
                    </head>
                    <body>
                        <div class="no-print">
                            <button onclick="window.print()">چاپ / ذخیره PDF</button>
                        </div>
                        ${reportContent}
                    </body>
                </html>`;
            newWindow.document.write(finalHtml);
            newWindow.document.close();
        });

        copyTextBtn.addEventListener('click', () => {
            const range = document.createRange();
            range.selectNode(outputContainer);
            window.getSelection().removeAllRanges();
            window.getSelection().addRange(range);
            try {
                document.execCommand('copy');
                alert('متن گزارش با موفقیت کپی شد!');
            } catch (err) {
                alert('خطا در کپی کردن!');
            }
            window.getSelection().removeAllRanges();
        });

        // --- Help Modal Logic ---
        helpBtn.addEventListener('click', () => helpModal.classList.remove('hidden'));
        closeHelpBtn.addEventListener('click', () => helpModal.classList.add('hidden'));
        helpModal.addEventListener('click', (e) => { if (e.target === helpModal) helpModal.classList.add('hidden'); });
        helpContentContainer.innerHTML = `
            <h2>راهنمای استفاده</h2>
            <p>این ابزار دو قابلیت اصلی را در اختیار شما قرار می‌دهد:</p>
            <ul>
                <li><strong>تدوین شناسنامه:</strong> با ارائه شرح فرایند، یک شناسنامه استاندارد و کامل مطابق فرم سازمانی دریافت کنید.</li>
                <li><strong>تحلیل بازمهندسی:</strong> با ارائه شناسنامه فرایند و اطلاعات تکمیلی، یک گزارش تحلیلی شامل وضعیت موجود و مطلوب، شاخص‌ها و راهکارهای بهبود دریافت کنید.</li>
            </ul>
            <h2>نحوه کار</h2>
            <p>۱. ابتدا وارد ابزار شوید. سپس نوع تحلیل مورد نظر خود را انتخاب کنید.</p>
            <p>۲. اطلاعات مربوطه را در کادرهای متنی وارد کرده یا از طریق دکمه "بارگذاری فایل"، فایل‌های Word، PDF یا تصویر خود را بارگذاری نمایید.</p>
            <p>۳. روی دکمه "تحلیل و تولید گزارش" کلیک کنید. پس از تولید گزارش، می‌توانید محتوای جداول را ویرایش کنید.</p>
            <p>۴. از دکمه "ذخیره گزارش" برای نگهداری نسخه فعلی در مرورگر استفاده کنید. گزارش‌های ذخیره شده از طریق آیکون آرشیو در بالای صفحه قابل دسترس هستند.</p>
            <p>۵. از دکمه‌های "گزارش نهایی" برای چاپ یا ذخیره به صورت PDF و "کپی متن" برای انتقال به نرم‌افزارهای دیگر استفاده کنید.</p>
        `;
    </script>
</body>
</html>
