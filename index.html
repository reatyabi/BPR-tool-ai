<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ابزار هوشمند بازمهندسی فرآیند</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js`;</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.18/mammoth.browser.min.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@2/dist/tesseract.min.js'></script>
    
    <style>
        body { font-family: 'Vazirmatn', sans-serif; }
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid #3498db; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .file-input-label { cursor: pointer; display: inline-block; padding: 0.5rem 1rem; margin-top: 0.5rem; background-color: #e9e9e9; color: #4a5568; border-radius: 0.5rem; transition: background-color 0.2s; border: 1px solid #ccc; }
        .file-input-label:hover { background-color: #dcdcdc; }
        .processing-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(255, 255, 255, 0.8); display: flex; justify-content: center; align-items: center; z-index: 10; border-radius: 0.5rem; flex-direction: column; }
        [contenteditable="true"] { background-color: #f0f9ff; outline: 2px dashed #90cdf4; outline-offset: 2px; cursor: text; padding: 4px; border-radius: 4px; min-height: 2rem; }
        [contenteditable="true"]:focus { background-color: #ffffff; outline: 2px solid #3b82f6; }
        .placeholder-text { color: #a0aec0; font-style: italic; }
        .copy-feedback { transition: opacity 0.5s; }
        .modal-overlay { transition: opacity 0.3s ease; }
        .mic-btn.recording { color: #ef4444; background-color: #fee2e2; }
        textarea.recording { border-color: #ef4444; box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.4); }
        .help-content h1 { font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem; }
        .help-content h2 { font-size: 1.25rem; font-weight: bold; margin-top: 1.5rem; margin-bottom: 0.75rem; border-bottom: 1px solid #e2e8f0; padding-bottom: 0.25rem;}
        .help-content h3 { font-size: 1.1rem; font-weight: bold; margin-top: 1rem; margin-bottom: 0.5rem; }
        .help-content p { margin-bottom: 1rem; line-height: 1.7; }
        .help-content ul { list-style-type: disc; margin-right: 1.5rem; margin-bottom: 1rem; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Login View -->
    <div id="login-view" class="min-h-screen flex items-center justify-center bg-gray-200 p-4">
        <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md text-right">
            <h2 class="text-2xl font-bold mb-6 text-center">ورود به ابزار تحلیل فرآیند</h2>
            <div class="space-y-4">
                <div>
                    <label for="user-name" class="block mb-2 font-semibold text-gray-700">نام و نام خانوادگی</label>
                    <input type="text" id="user-name" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="مثال: رضا اطیابی">
                </div>
                <div>
                    <label for="user-mobile" class="block mb-2 font-semibold text-gray-700">شماره موبایل</label>
                    <input type="text" id="user-mobile" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="مثال: 09123456789">
                </div>
                <div>
                    <label for="usage-code" class="block mb-2 font-semibold text-gray-700">کد استفاده</label>
                    <input type="text" id="usage-code" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="کد ۱۰ رقمی دریافتی را وارد کنید">
                </div>
                <button id="login-btn" class="w-full mt-4 bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700">ورود</button>
                <p id="login-error" class="text-red-500 text-sm text-center mt-2 hidden"></p>
            </div>
             <div class="mt-6 text-center text-sm">
                <a href="mailto:iamatyabi@gmail.com?subject=درخواست%20کد%20استفاده%20از%20ابزار%20بازمهندسی%20فرآیند" class="text-blue-600 hover:underline">درخواست کد استفاده</a>
                <span class="mx-2 text-gray-400">|</span>
                <button id="share-tool-login" class="text-blue-600 hover:underline">اشتراک‌گذاری ابزار</button>
            </div>
        </div>
    </div>

    <!-- App View -->
    <div id="app-view" class="hidden">
        <div class="container mx-auto p-4 md:p-8">
            <header class="mb-8">
                <div class="flex flex-col md:flex-row md:justify-between md:items-center">
                    <!-- Icons Group -->
                    <div class="w-full md:w-auto flex justify-center md:justify-start space-x-2 rtl:space-x-reverse mb-4 md:mb-0 md:order-1">
                        <div id="saved-reports-container" class="relative inline-block text-left">
                            <button id="saved-reports-btn" type="button" title="گزارش‌های ذخیره شده" class="inline-flex items-center justify-center w-10 h-10 rounded-md border border-gray-300 shadow-sm p-2 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" /></svg>
                            </button>
                            <div id="saved-reports-menu" class="origin-top-left absolute left-0 mt-2 w-72 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 hidden">
                                <div id="saved-reports-list" class="py-1" role="menu" aria-orientation="vertical"></div>
                            </div>
                        </div>
                        <button id="change-format-btn" type="button" title="تغییر فرمت خروجی" class="inline-flex items-center justify-center w-10 h-10 rounded-md border border-gray-300 shadow-sm p-2 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                        </button>
                        <button id="share-tool-main" type="button" title="اشتراک‌گذاری ابزار" class="inline-flex items-center justify-center w-10 h-10 rounded-md border border-gray-300 shadow-sm p-2 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12s-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.368a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z" /></svg>
                        </button>
                         <button id="help-btn" type="button" title="راهنما" class="inline-flex items-center justify-center w-10 h-10 rounded-md border border-gray-300 shadow-sm p-2 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        </button>
                    </div>
                    <!-- Title Group -->
                    <div class="text-center md:order-2">
                        <h1 class="text-3xl md:text-4xl font-bold text-gray-700">ابزار هوشمند بازمهندسی فرآیند</h1>
                        <p id="mode-indicator" class="text-gray-500 mt-2">اطلاعات در این مرورگر ذخیره می‌شود.</p>
                    </div>
                    <!-- Spacer for Desktop -->
                    <div class="hidden md:block md:w-auto md:order-3 invisible">
                         <div class="flex space-x-2 rtl:space-x-reverse">
                            <div class="w-10 h-10"></div><div class="w-10 h-10"></div><div class="w-10 h-10"></div><div class="w-10 h-10"></div>
                         </div>
                    </div>
                </div>
            </header>

            <div class="flex flex-col gap-8">
                <!-- Input Section -->
                <div class="bg-white p-6 rounded-xl shadow-lg w-full">
                    <h2 class="text-2xl font-bold mb-4 border-b pb-2">۱. ورود اطلاعات</h2>
                    <div class="mb-6">
                        <label for="process-info" class="block mb-2 font-semibold text-gray-700">شناسنامه و اطلاعات فرآیند</label>
                        <div class="relative">
                            <textarea id="process-info" rows="5" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="مثال: عنوان فرآیند: درخواست مرخصی.&#10;کد: HR-02..."></textarea>
                            <button class="mic-btn absolute top-2 left-2 text-gray-500 hover:text-blue-600 p-1" data-target="process-info" title="ورود صوتی">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" /></svg>
                            </button>
                        </div>
                        <label for="process-info-file" class="file-input-label">بارگذاری فایل</label>
                        <input type="file" id="process-info-file" class="hidden" accept=".txt,.pdf,.docx,.png,.jpg,.jpeg">
                        <div id="process-info-loader" class="processing-overlay hidden"><div class="loader"></div></div>
                    </div>
                    <div class="mb-6">
                        <label for="meeting-notes" class="block mb-2 font-semibold text-gray-700">متن پیاده‌سازی شده جلسات</label>
                        <div class="relative">
                            <textarea id="meeting-notes" rows="8" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="مثال:&#10;آقای احمدی (فنی): فرم‌های کاغذی وقت‌گیر هستند..."></textarea>
                            <button class="mic-btn absolute top-2 left-2 text-gray-500 hover:text-blue-600 p-1" data-target="meeting-notes" title="ورود صوتی">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" /></svg>
                            </button>
                        </div>
                        <label for="meeting-notes-file" class="file-input-label">بارگذاری فایل</label>
                        <input type="file" id="meeting-notes-file" class="hidden" accept=".txt,.pdf,.docx,.png,.jpg,.jpeg">
                        <div id="meeting-notes-loader" class="processing-overlay hidden"><div class="loader"></div></div>
                    </div>
                    <div class="mb-6">
                        <label for="expert-analysis" class="block mb-2 font-semibold text-gray-700">تحلیل متخصصین</label>
                        <div class="relative">
                            <textarea id="expert-analysis" rows="5" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="مثال:&#10;تحلیل مشاور: فرآیند به شدت دستی و وابسته به کاغذ است..."></textarea>
                            <button class="mic-btn absolute top-2 left-2 text-gray-500 hover:text-blue-600 p-1" data-target="expert-analysis" title="ورود صوتی">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" /></svg>
                            </button>
                        </div>
                        <label for="expert-analysis-file" class="file-input-label">بارگذاری فایل</label>
                        <input type="file" id="expert-analysis-file" class="hidden" accept=".txt,.pdf,.docx,.png,.jpg,.jpeg">
                        <div id="expert-analysis-loader" class="processing-overlay hidden"><div class="loader"></div></div>
                    </div>
                    <button id="analyze-btn" class="w-full mt-4 bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700">تحلیل و تکمیل گزارش بازمهندسی فرایند</button>
                </div>

                <!-- Output Section -->
                <div class="bg-white p-6 rounded-xl shadow-lg w-full">
                    <h2 class="text-2xl font-bold mb-4 border-b pb-2">۲. فرم تحلیل شده بازمهندسی</h2>
                    <p class="text-sm text-gray-500 mb-4">نکته: می‌توانید روی سلول‌های آبی‌رنگ کلیک کرده و محتوای آن‌ها را ویرایش کنید.</p>
                    <div id="output-container" class="space-y-6">
                        <div id="loader" class="hidden justify-center items-center py-10"><div class="loader"></div><p class="mr-4">در حال تحلیل هوشمند...</p></div>
                        <div id="form-content"><p class="text-center text-gray-500 py-10">خروجی تحلیل در اینجا نمایش داده خواهد شد.</p></div>
                        <div id="error-message" class="hidden text-center text-red-500 p-4 bg-red-100 rounded-lg"></div>
                        <div id="action-buttons" class="hidden text-center pt-4 flex flex-col sm:flex-row sm:justify-center sm:space-x-4 rtl:sm:space-x-reverse space-y-2 sm:space-y-0">
                            <button id="save-report-btn" class="bg-teal-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-teal-700">ذخیره گزارش در ابزار</button>
                            <button id="generate-doc-btn" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700">گزارش نهایی</button>
                            <button id="copy-text-btn" class="bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-indigo-700">کپی متن گزارش</button>
                        </div>
                        <div id="copy-feedback" class="text-center text-green-600 font-semibold opacity-0 copy-feedback">گزارش با موفقیت کپی شد!</div>
                    </div>
                </div>
            </div>
            <footer id="app-footer" class="text-center text-sm text-gray-500 mt-8 py-4 border-t" dir="ltr">
                Tool created by: Reza Atyabi - <a href="mailto:iamatyabi@gmail.com" class="text-blue-600 hover:underline">iamatyabi@gmail.com</a>
            </footer>
        </div>
    </div>

    <!-- Output Format Modal -->
    <div id="format-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden modal-overlay">
        <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-2xl shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">انتخاب بخش‌های گزارش</h3>
                <div id="format-checklist" class="mt-4 px-7 py-3 text-right space-y-3">
                    <!-- Checkboxes will be generated here -->
                </div>
                <div class="items-center px-4 py-3">
                    <button id="save-format-btn" class="px-4 py-2 bg-green-500 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-green-600">ذخیره</button>
                    <button id="reset-format-btn" class="px-4 py-2 bg-yellow-500 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-yellow-600">بازگشت به پیش‌فرض</button>
                    <button id="cancel-format-btn" class="px-4 py-2 bg-gray-300 text-gray-800 text-base font-medium rounded-md w-auto shadow-sm hover:bg-gray-400 mr-2">انصراف</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div id="help-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden modal-overlay">
        <div class="relative top-10 mx-auto p-5 border w-11/12 max-w-4xl shadow-lg rounded-md bg-white">
            <div class="mt-3 text-right">
                <div class="flex justify-between items-center border-b pb-3">
                    <h3 class="text-xl leading-6 font-medium text-gray-900">راهنمای ابزار هوشمند بازمهندسی فرآیند</h3>
                    <button id="close-help-btn" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <div class="mt-4 help-content max-h-[70vh] overflow-y-auto pr-2">
                    <!-- Help content will be injected here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const loginView = document.getElementById('login-view');
        const appView = document.getElementById('app-view');
        const loginBtn = document.getElementById('login-btn');
        const userNameInput = document.getElementById('user-name');
        const userMobileInput = document.getElementById('user-mobile');
        const usageCodeInput = document.getElementById('usage-code');
        const loginError = document.getElementById('login-error');
        const savedReportsBtn = document.getElementById('saved-reports-btn');
        const savedReportsMenu = document.getElementById('saved-reports-menu');
        const savedReportsList = document.getElementById('saved-reports-list');
        const saveReportBtn = document.getElementById('save-report-btn');
        const changeFormatBtn = document.getElementById('change-format-btn');
        const formatModal = document.getElementById('format-modal');
        const formatChecklist = document.getElementById('format-checklist');
        const saveFormatBtn = document.getElementById('save-format-btn');
        const cancelFormatBtn = document.getElementById('cancel-format-btn');
        const resetFormatBtn = document.getElementById('reset-format-btn');
        const shareToolLoginBtn = document.getElementById('share-tool-login');
        const shareToolMainBtn = document.getElementById('share-tool-main');
        const helpBtn = document.getElementById('help-btn');
        const helpModal = document.getElementById('help-modal');
        const closeHelpBtn = document.getElementById('close-help-btn');
        
        const analyzeBtn = document.getElementById('analyze-btn');
        const textareas = { processInfo: document.getElementById('process-info'), meetingNotes: document.getElementById('meeting-notes'), expertAnalysis: document.getElementById('expert-analysis') };
        const fileInputs = { processInfo: document.getElementById('process-info-file'), meetingNotes: document.getElementById('meeting-notes-file'), expertAnalysis: document.getElementById('expert-analysis-file') };
        const loaders = { processInfo: document.getElementById('process-info-loader'), meetingNotes: document.getElementById('meeting-notes-loader'), expertAnalysis: document.getElementById('expert-analysis-loader') };
        const mainLoader = document.getElementById('loader');
        const formContent = document.getElementById('form-content');
        const errorMessage = document.getElementById('error-message');
        const actionButtons = document.getElementById('action-buttons');
        const generateDocBtn = document.getElementById('generate-doc-btn');
        const copyTextBtn = document.getElementById('copy-text-btn');
        const copyFeedback = document.getElementById('copy-feedback');
        const appFooter = document.getElementById('app-footer');

        let currentUser = null;
        let recognition = null;
        let activeMicButton = null;

        const outputSectionsConfig = {
            info: { label: "اطلاعات کلی فرآیند", instruction: "1. **اطلاعات کلی فرآیند**: عنوان و کد فرآیند." },
            components: { label: "جدول تحلیل مولفه‌ها", instruction: "2. **جدول تحلیل مولفه‌ها**: وضعیت موجود و مطلوب برای هر یک از 9 مولفه اصلی با شماره ردیف دقیق." },
            indicators: { label: "جدول شاخص‌های پایش", instruction: "3. **جدول شاخص‌های پایش**: شاخص‌های کلیدی عملکرد (KPI). به طور خاص، معیارها و دوره پایش را از متن 'اطلاعات فرآیند' استخراج کن. مقدار شاخص را فقط در صورتی که به صراحت در متن ذکر شده است، وارد کن. در غیر این صورت، آن را خالی بگذار." },
            solutions: { label: "جدول مشکلات و راهکارها", instruction: "4. **جدول مشکلات و راهکارها**: مشکلات، راهکارهای اجرایی دقیق و قابل عمل، مسئول اجرا و مهلت انجام." }
        };
        let activeOutputSections = { info: true, components: true, indicators: true, solutions: true };

        const validCodes = ["A5B1C9D8E2", "F4G7H3J1K6", "L2M8N5P3Q9", "R7S4T1U6V2", "W8X3Y9Z5A1", "B6C2D8E4F7", "G3H9J5K1L4", "M8N2P7Q3R9", "S5T1U6V2W8", "X4Y9Z5A1B6", "C2D8E4F7G3", "H9J5K1L4M8", "N2P7Q3R9S5", "T1U6V2W8X4", "Y9Z5A1B6C2", "D8E4F7G3H9", "J5K1L4M8N2", "P7Q3R9S5T1", "U6V2W8X4Y9", "Z5A1B6C2D8", "E4F7G3H9J5", "K1L4M8N2P7", "Q3R9S5T1U6", "V2W8X4Y9Z5", "A1B6C2D8E4", "F7G3H9J5K1", "L4M8N2P7Q3", "R9S5T1U6V2", "W8X4Y9Z5A1", "B6C2D8E4F7", "G3H9J5K1L4", "M8N2P7Q3R9", "S5T1U6V2W8", "X4Y9Z5A1B6", "C2D8E4F7G3", "H9J5K1L4M8", "N2P7Q3R9S5", "T1U6V2W8X4", "Y9Z5A1B6C2", "D8E4F7G3H9", "J5K1L4M8N2", "P7Q3R9S5T1", "U6V2W8X4Y9", "Z5A1B6C2D8", "E4F7G3H9J5", "K1L4M8N2P7", "Q3R9S5T1U6", "V2W8X4Y9Z5", "A1B6C2D8E4", "F7G3H9J5K1", "L4M8N2P7Q3", "R9S5T1U6V2", "W8X4Y9Z5A1", "B6C2D8E4F7", "G3H9J5K1L4", "M8N2P7Q3R9", "S5T1U6V2W8", "X4Y9Z5A1B6", "C2D8E4F7G3", "H9J5K1L4M8", "N2P7Q3R9S5", "T1U6V2W8X4", "Y9Z5A1B6C2", "D8E4F7G3H9", "J5K1L4M8N2", "P7Q3R9S5T1", "U6V2W8X4Y9", "Z5A1B6C2D8", "E4F7G3H9J5", "K1L4M8N2P7", "Q3R9S5T1U6", "V2W8X4Y9Z5", "A1B6C2D8E4", "F7G3H9J5K1", "L4M8N2P7Q3", "R9S5T1U6V2", "W8X4Y9Z5A1", "B6C2D8E4F7", "G3H9J5K1L4", "M8N2P7Q3R9", "S5T1U6V2W8", "X4Y9Z5A1B6", "C2D8E4F7G3", "H9J5K1L4M8", "N2P7Q3R9S5", "T1U6V2W8X4", "Y9Z5A1B6C2", "D8E4F7G3H9", "J5K1L4M8N2", "P7Q3R9S5T1", "U6V2W8X4Y9", "Z5A1B6C2D8", "E4F7G3H9J5", "K1L4M8N2P7", "Q3R9S5T1U6", "V2W8X4Y9Z5", "A1B6C2D8E4", "F7G3H9J5K1", "L4M8N2P7Q3", "R9S5T1U6V2"];

        // --- Authentication Logic (Using localStorage) ---
        loginBtn.addEventListener('click', () => {
            const name = userNameInput.value.trim();
            const mobile = userMobileInput.value.trim();
            const code = usageCodeInput.value.trim();

            if (!name || !mobile || !code) {
                loginError.textContent = 'لطفاً تمام فیلدها را تکمیل کنید.';
                loginError.classList.remove('hidden');
                return;
            }

            if (!validCodes.includes(code)) {
                loginError.textContent = 'کد استفاده نامعتبر است.';
                loginError.classList.remove('hidden');
                return;
            }
            
            const registeredUsers = JSON.parse(localStorage.getItem('bprRegisteredUsers') || '{}');
            if (registeredUsers[code] && registeredUsers[code].mobile !== mobile) {
                loginError.textContent = 'این کد استفاده قبلاً برای کاربر دیگری ثبت شده است.';
                loginError.classList.remove('hidden');
                return;
            }

            // Register or update user
            registeredUsers[code] = { name, mobile };
            localStorage.setItem('bprRegisteredUsers', JSON.stringify(registeredUsers));

            loginError.classList.add('hidden');
            currentUser = { name, mobile, code };
            
            // Save current user session
            localStorage.setItem('bprCurrentUser', JSON.stringify(currentUser));

            // Switch views
            loginView.classList.add('hidden');
            appView.classList.remove('hidden');
            
            loadSavedReports();
            loadOutputFormat();
        });

        // --- Saved Reports Logic (Using localStorage) ---
        savedReportsBtn.addEventListener('click', () => {
            savedReportsMenu.classList.toggle('hidden');
        });

        function loadSavedReports() {
            if (!currentUser) return;
            const reportsKey = `bprReports_${currentUser.code}`;
            const reports = JSON.parse(localStorage.getItem(reportsKey) || '[]');
            
            savedReportsList.innerHTML = ''; 
            if (reports.length === 0) {
                 savedReportsList.innerHTML = '<p class="px-4 py-2 text-xs text-gray-500">گزارشی یافت نشد.</p>';
            } else {
                reports.forEach((report) => {
                    const reportItem = document.createElement('div');
                    reportItem.className = 'flex items-center justify-between px-4 py-2 text-sm text-gray-700 hover:bg-gray-100';

                    const reportLink = document.createElement('a');
                    reportLink.href = '#';
                    reportLink.className = 'flex-grow';
                    reportLink.innerHTML = `<span class="font-semibold">${report.title}</span><br><span class="text-xs text-gray-500">${new Date(report.timestamp).toLocaleDateString('fa-IR')}</span>`;
                    reportLink.onclick = (e) => {
                        e.preventDefault();
                        downloadReport(report.htmlContent, report.title);
                        savedReportsMenu.classList.add('hidden');
                    };

                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'text-red-500 hover:text-red-700 p-1';
                    deleteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>`;
                    deleteBtn.onclick = (e) => {
                        e.stopPropagation();
                        deleteReport(report.timestamp);
                    };

                    reportItem.appendChild(reportLink);
                    reportItem.appendChild(deleteBtn);
                    savedReportsList.appendChild(reportItem);
                });
            }
        }

        function deleteReport(timestamp) {
            if (!currentUser) return;
            if (!confirm('آیا از حذف این گزارش اطمینان دارید؟ این عمل قابل بازگشت نیست.')) return;
            const reportsKey = `bprReports_${currentUser.code}`;
            let reports = JSON.parse(localStorage.getItem(reportsKey) || '[]');
            reports = reports.filter(report => report.timestamp !== timestamp);
            localStorage.setItem(reportsKey, JSON.stringify(reports));
            loadSavedReports();
        }

        function downloadReport(htmlContent, title) {
            const newWindow = window.open('', '', 'width=800,height=600');
            const finalHtml = generateFinalHtml(htmlContent, false, title); 
            newWindow.document.write(finalHtml);
            newWindow.document.close();
            newWindow.focus();
        }

        // --- Save Report Logic (Using localStorage) ---
        saveReportBtn.addEventListener('click', () => {
            if (!currentUser) {
                alert('خطا: کاربر شناسایی نشد.');
                return;
            }
            const htmlContent = formContent.innerHTML;
            const processCodeEl = formContent.querySelector('#process-info-table tbody tr:nth-child(2) td:last-child div');
            const processTitleEl = formContent.querySelector('#process-info-table tbody tr:first-child td:last-child div');
            
            const reportName = (processCodeEl && processCodeEl.innerText.trim() && !processCodeEl.querySelector('.placeholder-text')) 
                ? processCodeEl.innerText.trim() 
                : (processTitleEl && !processTitleEl.querySelector('.placeholder-text') ? processTitleEl.innerText : 'گزارش_بدون_نام');

            const reportsKey = `bprReports_${currentUser.code}`;
            const reports = JSON.parse(localStorage.getItem(reportsKey) || '[]');
            
            reports.unshift({ // Add to the beginning of the list
                title: reportName,
                htmlContent: htmlContent,
                timestamp: new Date().toISOString()
            });

            localStorage.setItem(reportsKey, JSON.stringify(reports));
            
            alert('گزارش با موفقیت در این مرورگر ذخیره شد!');
            loadSavedReports(); // Refresh the list
        });


        // --- File Upload Logic ---
        function setupFileUploader(key) {
            fileInputs[key].addEventListener('change', async (event) => {
                const file = event.target.files[0];
                if (!file) return;
                loaders[key].classList.remove('hidden');
                try {
                    let text = '';
                    if (file.type === "text/plain") {
                        text = await file.text();
                    } else if (file.name.endsWith('.docx')) {
                        const arrayBuffer = await file.arrayBuffer();
                        const result = await mammoth.extractRawText({ arrayBuffer });
                        text = result.value;
                    } else if (file.type === "application/pdf") {
                        const arrayBuffer = await file.arrayBuffer();
                        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                        let fullText = '';
                        for (let i = 1; i <= pdf.numPages; i++) {
                            const page = await pdf.getPage(i);
                            const textContent = await page.getTextContent();
                            fullText += textContent.items.map(item => item.str).join(' ') + '\n';
                        }
                        text = fullText;
                    } else if (file.type.startsWith('image/')) {
                        const worker = await Tesseract.createWorker('fas');
                        await worker.load();
                        await worker.loadLanguage('fas');
                        await worker.initialize('fas');
                        const { data: { text: ocrText } } = await worker.recognize(file);
                        text = ocrText;
                        await worker.terminate();
                    } else {
                        throw new Error('فرمت فایل پشتیبانی نمی‌شود.');
                    }
                    textareas[key].value = text;
                } catch (err) {
                    alert(`خطا در پردازش فایل: ${err.message}`);
                    console.error(err);
                } finally {
                    loaders[key].classList.add('hidden');
                    fileInputs[key].value = '';
                }
            });
        }
        Object.keys(fileInputs).forEach(key => setupFileUploader(key));
        
        // --- Analysis Logic ---
        analyzeBtn.addEventListener('click', async () => {
            const processInfo = textareas.processInfo.value.trim();
            const meetingNotes = textareas.meetingNotes.value.trim();
            const expertAnalysis = textareas.expertAnalysis.value.trim();

            if (!processInfo) {
                errorMessage.textContent = 'لطفاً بخش شناسنامه و اطلاعات فرآیند را برای تعیین موضوع تحلیل، تکمیل کنید.';
                errorMessage.classList.remove('hidden');
                return;
            }
            
            formContent.innerHTML = '';
            actionButtons.classList.add('hidden');
            errorMessage.classList.add('hidden');
            mainLoader.style.display = 'flex';

            const requestedInstructions = Object.keys(activeOutputSections)
                .filter(key => activeOutputSections[key])
                .map(key => outputSectionsConfig[key].instruction)
                .join('\n');

            const prompt = `
                شما یک مشاور خبره بازمهندسی فرآیندهای کسب‌وکار (BPR) هستید. وظیفه شما تحلیل اطلاعات ورودی مرتبط و تکمیل خروجی بر اساس فرمت درخواستی کاربر است. خروجی شما باید فقط یک شیء JSON معتبر باشد. تمام رشته‌ها در JSON باید به درستی escape شوند (مثلا \\n برای خط جدید و \\" برای کوتیشن).

                **فرمت خروجی درخواستی کاربر**:
                ${requestedInstructions}

                ### ورودی‌ها ###
                1. **اطلاعات فرآیند (موضوع اصلی تحلیل)**: 
                ${processInfo}

                2. **متن جلسات**: 
                ${meetingNotes || 'ارائه نشده است.'}

                3. **تحلیل متخصصین**: 
                ${expertAnalysis || 'ارائه نشده است.'}
            `;

            try {
                const result = await callGeminiAPI(prompt);
                displayResults(result);
            } catch (error) {
                console.error('Error during analysis:', error);
                errorMessage.classList.remove('hidden');
                errorMessage.textContent = `خطا در تحلیل اطلاعات: ${error.message}. لطفاً ورودی‌ها را بررسی کرده و دوباره تلاش کنید.`;
                formContent.innerHTML = '<p class="text-center text-gray-500 py-10">تحلیل با خطا مواجه شد.</p>';
            } finally {
                mainLoader.style.display = 'none';
            }
        });

        async function callGeminiAPI(prompt) {
            const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = {
                contents: chatHistory,
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            processTitle: { "type": "STRING", "nullable": true },
                            processCode: { "type": "STRING", "nullable": true },
                            componentsAnalysis: {
                                "type": "ARRAY", "nullable": true,
                                "items": {
                                    "type": "OBJECT",
                                    "properties": {
                                        "id": { "type": "NUMBER" },
                                        "component": { "type": "STRING" },
                                        "currentState": { "type": "STRING" },
                                        "desiredState": { "type": "STRING" }
                                    },
                                    "required": ["id", "component", "currentState", "desiredState"]
                                }
                            },
                            indicators: {
                                "type": "ARRAY", "nullable": true,
                                "items": {
                                    "type": "OBJECT",
                                    "properties": {
                                        "title": { "type": "STRING" },
                                        "acceptanceCriteria": { "type": "STRING" },
                                        "monitoringPeriod": { "type": "STRING" },
                                        "value": { "type": "STRING" }
                                    },
                                    "required": ["title", "acceptanceCriteria", "monitoringPeriod", "value"]
                                }
                            },
                            solutions: {
                                "type": "ARRAY", "nullable": true,
                                "items": {
                                    "type": "OBJECT",
                                    "properties": {
                                        "problemTitle": { "type": "STRING" },
                                        "improvementAction": { "type": "STRING" },
                                        "responsible": { "type": "STRING" },
                                        "deadline": { "type": "STRING" }
                                    },
                                     "required": ["problemTitle", "improvementAction", "responsible", "deadline"]
                                }
                            }
                        },
                    }
                }
            };

            const apiKey = "AIzaSyDMKdS-fWK9gSKZZ9EsUaGYfQRk4S-nPRI"; // User provided API Key
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
            
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorBody = await response.text();
                throw new Error(`API call failed with status: ${response.status}. Body: ${errorBody}`);
            }
            
            const result = await response.json();

            if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts) {
                const jsonText = result.candidates[0].content.parts[0].text;
                return JSON.parse(jsonText);
            } else {
                console.error("Unexpected API response structure:", result);
                throw new Error("پاسخ نامعتبر از سرویس هوش مصنوعی دریافت شد.");
            }
        }

        function createEditableCell(content) {
            const cell = document.createElement('td');
            cell.className = 'border p-2';
            const div = document.createElement('div');
            div.setAttribute('contenteditable', 'true');
            if (content && content.trim()) {
                div.innerText = content;
            } else {
                div.innerHTML = `<span class="placeholder-text">جهت تکمیل کلیک کنید</span>`;
                div.onfocus = () => {
                    if (div.querySelector('.placeholder-text')) {
                        div.innerHTML = '';
                    }
                };
                div.onblur = () => {
                    if (div.innerText.trim() === '') {
                         div.innerHTML = `<span class="placeholder-text">جهت تکمیل کلیک کنید</span>`;
                    }
                };
            }
            cell.appendChild(div);
            return cell;
        }

        function displayResults(data) {
            formContent.innerHTML = '';
            if (!data) {
                 formContent.innerHTML = '<p class="text-center text-gray-500 py-10">تحلیلی یافت نشد. لطفاً کیفیت و ارتباط اطلاعات ورودی را بررسی کنید.</p>';
                 actionButtons.classList.add('hidden');
                 return;
            }

            // --- Process Info Table ---
            if (data.processTitle || data.processCode) {
                const infoTable = document.createElement('table');
                infoTable.id = 'process-info-table';
                infoTable.className = 'w-full border-collapse text-sm mb-8';
                infoTable.innerHTML = `
                    <caption class="text-lg font-bold p-2 mb-2 text-right">اطلاعات کلی فرآیند</caption>
                    <tbody>
                        <tr><td class="border p-2 font-semibold w-1/4">عنوان فرآیند</td></tr>
                        <tr><td class="border p-2 font-semibold w-1/4">کد فرآیند</td></tr>
                    </tbody>
                `;
                const infoBody = infoTable.querySelector('tbody');
                infoBody.rows[0].appendChild(createEditableCell(data.processTitle));
                infoBody.rows[1].appendChild(createEditableCell(data.processCode));
                formContent.appendChild(infoTable);
            }

            // --- Components Analysis Table ---
            if (data.componentsAnalysis && data.componentsAnalysis.length > 0) {
                const componentsTable = document.createElement('table');
                componentsTable.id = 'components-table';
                componentsTable.className = 'w-full border-collapse text-sm mb-8';
                componentsTable.innerHTML = `
                    <caption class="text-lg font-bold p-2 mb-2 text-right">جدول تحلیل مولفه‌ها</caption>
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="border p-2 w-8">ردیف</th>
                            <th class="border p-2 text-right">مولفه تحلیل</th>
                            <th class="border p-2 text-right">وضعیت موجود</th>
                            <th class="border p-2 text-right">وضعیت مطلوب</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                `;
                const tbody = componentsTable.querySelector('tbody');
                data.componentsAnalysis.forEach((item, index) => {
                    const row = document.createElement('tr');
                    row.className = 'border-b hover:bg-gray-50 align-top';
                    const idCell = document.createElement('td');
                    idCell.className = 'border p-2 text-center';
                    idCell.textContent = index + 1;
                    row.appendChild(idCell);
                    row.appendChild(createEditableCell(item.component));
                    row.appendChild(createEditableCell(item.currentState));
                    row.appendChild(createEditableCell(item.desiredState));
                    tbody.appendChild(row);
                });
                formContent.appendChild(componentsTable);
            }


            // --- Indicators Table ---
            if (data.indicators && data.indicators.length > 0) {
                const indicatorsTable = document.createElement('table');
                indicatorsTable.id = 'indicators-table';
                indicatorsTable.className = 'w-full border-collapse text-sm mb-8';
                indicatorsTable.innerHTML = `
                    <caption class="text-lg font-bold p-2 mb-2 text-right">جدول شاخص‌های پایش و اندازه‌گیری</caption>
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="border p-2 w-8">ردیف</th>
                            <th class="border p-2 text-right">شاخص‌های پایش و اندازه‌گیری</th>
                            <th class="border p-2 text-right">معیارهای پذیرش</th>
                            <th class="border p-2 text-right">دوره پایش و اندازه‌گیری</th>
                            <th class="border p-2 text-right">مقدار شاخص</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                `;
                const tbody = indicatorsTable.querySelector('tbody');
                data.indicators.forEach((item, index) => {
                    const row = document.createElement('tr');
                    row.className = 'border-b hover:bg-gray-50 align-top';
                    const idCell = document.createElement('td');
                    idCell.className = 'border p-2 text-center';
                    idCell.textContent = index + 1;
                    row.appendChild(idCell);
                    row.appendChild(createEditableCell(item.title));
                    row.appendChild(createEditableCell(item.acceptanceCriteria));
                    row.appendChild(createEditableCell(item.monitoringPeriod));
                    row.appendChild(createEditableCell(item.value));
                    tbody.appendChild(row);
                });
                formContent.appendChild(indicatorsTable);
            }

            // --- Solutions Table ---
            if (data.solutions && data.solutions.length > 0) {
                const solutionsTable = document.createElement('table');
                solutionsTable.id = 'solutions-table';
                solutionsTable.className = 'w-full border-collapse text-sm';
                solutionsTable.innerHTML = `
                    <caption class="text-lg font-bold p-2 mb-2 text-right">جدول مشکلات، عارضه‌ها و راهکارهای بهبود</caption>
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="border p-2 w-8">ردیف</th>
                            <th class="border p-2 text-right">مشکلات و عارضه‌ها</th>
                            <th class="border p-2 text-right">راهکارهای اجرایی بهبود</th>
                            <th class="border p-2 text-right">مسئول اجرا</th>
                            <th class="border p-2 text-right">مهلت انجام</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                `;
                const tbody = solutionsTable.querySelector('tbody');
                data.solutions.forEach((item, index) => {
                    const row = document.createElement('tr');
                    row.className = 'border-b hover:bg-gray-50 align-top';
                    row.innerHTML = `<td class="border p-2 text-center">${index + 1}</td>`;
                    row.appendChild(createEditableCell(item.problemTitle));
                    row.appendChild(createEditableCell(item.improvementAction));
                    row.appendChild(createEditableCell(item.responsible));
                    row.appendChild(createEditableCell(item.deadline));
                    tbody.appendChild(row);
                });
                formContent.appendChild(solutionsTable);
            }
            actionButtons.classList.remove('hidden');
        }
        
        function generateFinalHtml(content, isEditable, reportName) {
            let finalContent = content;
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = content;
            
            // Clean up placeholder text for final output
            tempDiv.querySelectorAll('.placeholder-text').forEach(el => {
                const parent = el.parentElement;
                if(parent) parent.innerHTML = '';
            });

            if (!isEditable) {
                tempDiv.querySelectorAll('[contenteditable="true"]').forEach(el => el.removeAttribute('contenteditable'));
            }
            finalContent = tempDiv.innerHTML;

            const reportTitle = "گزارش نهایی تحلیل فرآیند";
            const safeReportName = reportName.replace(/[^a-z0-9_.-]/gi, '_');

            return `
                <html>
                    <head>
                        <title>${reportTitle} - ${reportName}</title>
                        <script src="https://cdn.tailwindcss.com"><\/script>
                        <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
                        <style>
                            body { font-family: 'Vazirmatn', sans-serif; direction: rtl; padding: 2rem; }
                            table { border-collapse: collapse; width: 100%; margin-bottom: 2rem; }
                            th, td { border: 1px solid #ccc; padding: 8px; text-align: right; }
                            th { background-color: #f2f2f2; }
                            caption { font-size: 1.25rem; font-weight: bold; margin-bottom: 0.5rem; text-align: right; }
                            footer { text-align: center; font-size: 0.875rem; color: #6b7280; margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #e5e7eb; }
                            .no-print { display: block; text-align: left; margin-bottom: 1rem; padding: 1rem; background-color: #f9f9f9; border-radius: 8px; }
                            @media print { .no-print { display: none; } }
                        </style>
                    </head>
                    <body>
                        <div class="no-print">
                            <button onclick="window.print()" class="bg-red-500 text-white font-bold py-2 px-4 rounded">چاپ / ذخیره PDF</button>
                            <button onclick="downloadHtml()" class="bg-blue-500 text-white font-bold py-2 px-4 rounded">دانلود HTML</button>
                        </div>
                        <div id="report-content">
                            ${finalContent}
                        </div>
                        <footer dir="ltr">
                            Tool created by: Reza Atyabi - <a href="mailto:iamatyabi@gmail.com" class="text-blue-600 hover:underline">iamatyabi@gmail.com</a>
                        </footer>

                        <script>
                            function downloadHtml() {
                                const buttons = document.querySelector('.no-print');
                                buttons.style.display = 'none';
                                const htmlContent = document.documentElement.outerHTML;
                                buttons.style.display = 'block';

                                const blob = new Blob([htmlContent], { type: 'text/html' });
                                const url = URL.createObjectURL(blob);
                                const a = document.createElement('a');
                                a.href = url;
                                a.download = '${safeReportName}.html';
                                a.click();
                                URL.revokeObjectURL(url);
                            }
                        <\/script>
                    </body>
                </html>
            `;
        }

        // --- Generate Final HTML Document (Non-Editable) ---
        generateDocBtn.addEventListener('click', () => {
            const processCodeEl = formContent.querySelector('#process-info-table tbody tr:nth-child(2) td:last-child div');
            const processTitleEl = formContent.querySelector('#process-info-table tbody tr:first-child td:last-child div');
            const reportName = (processCodeEl && processCodeEl.innerText.trim() && !processCodeEl.querySelector('.placeholder-text')) 
                ? processCodeEl.innerText.trim() 
                : (processTitleEl ? processTitleEl.innerText : 'گزارش_بدون_نام');

            const contentToPrint = formContent.innerHTML;
            const newWindow = window.open('', '', 'width=800,height=600');
            const finalHtml = generateFinalHtml(contentToPrint, false, reportName);
            newWindow.document.write(finalHtml);
            newWindow.document.close();
            newWindow.focus();
        });

        // --- Copy Full Table HTML ---
        copyTextBtn.addEventListener('click', () => {
            const contentToCopy = formContent.innerHTML;
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = contentToCopy;
            
            // Clean up placeholder text before copying
            tempDiv.querySelectorAll('.placeholder-text').forEach(el => {
                const parent = el.parentElement;
                if(parent) parent.innerHTML = '';
            });
            tempDiv.querySelectorAll('[contenteditable="true"]').forEach(el => el.removeAttribute('contenteditable'));
            
            const htmlToCopy = `<div dir="rtl">${tempDiv.innerHTML}</div>`;

            function listener(e) {
                e.clipboardData.setData("text/html", htmlToCopy);
                e.clipboardData.setData("text/plain", "برای مشاهده جدول، لطفاً در یک ویرایشگر متن غنی (مانند Word) جای‌گذاری کنید.");
                e.preventDefault();
            }
            document.addEventListener("copy", listener);
            document.execCommand("copy");
            document.removeEventListener("copy", listener);

            // Show feedback
            copyFeedback.style.opacity = 1;
            setTimeout(() => {
                copyFeedback.style.opacity = 0;
            }, 2000);
        });

        // --- Output Format Modal Logic ---
        function populateFormatModal() {
            formatChecklist.innerHTML = '';
            for (const key in outputSectionsConfig) {
                const item = outputSectionsConfig[key];
                const isChecked = activeOutputSections[key];
                const div = document.createElement('div');
                div.className = 'flex items-center';
                div.innerHTML = `
                    <input id="format-${key}" name="format-section" type="checkbox" ${isChecked ? 'checked' : ''} class="h-4 w-4 text-indigo-600 border-gray-300 rounded ml-2">
                    <label for="format-${key}" class="text-sm text-gray-700">${item.label}</label>
                `;
                formatChecklist.appendChild(div);
            }
        }
        
        changeFormatBtn.addEventListener('click', () => {
            populateFormatModal();
            formatModal.classList.remove('hidden');
        });

        cancelFormatBtn.addEventListener('click', () => {
            formatModal.classList.add('hidden');
        });
        
        resetFormatBtn.addEventListener('click', () => {
            activeOutputSections = { info: true, components: true, indicators: true, solutions: true };
            localStorage.setItem('bprOutputFormat', JSON.stringify(activeOutputSections));
            alert('فرمت خروجی به حالت پیش‌فرض بازگشت.');
            formatModal.classList.add('hidden');
        });

        saveFormatBtn.addEventListener('click', () => {
            const newFormat = {};
            for (const key in outputSectionsConfig) {
                const checkbox = document.getElementById(`format-${key}`);
                newFormat[key] = checkbox.checked;
            }
            activeOutputSections = newFormat;
            localStorage.setItem('bprOutputFormat', JSON.stringify(activeOutputSections));
            alert('فرمت خروجی جدید ذخیره شد.');
            formatModal.classList.add('hidden');
        });

        function loadOutputFormat() {
            const savedFormat = localStorage.getItem('bprOutputFormat');
            if (savedFormat) {
                activeOutputSections = JSON.parse(savedFormat);
            }
        }


        // --- Check for saved user session on page load ---
        window.addEventListener('load', () => {
            const savedUser = localStorage.getItem('bprCurrentUser');
            if(savedUser) {
                currentUser = JSON.parse(savedUser);
                loginView.classList.add('hidden');
                appView.classList.remove('hidden');
                loadSavedReports();
                loadOutputFormat();
            }
        });
        
        // --- Speech Recognition Logic ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SpeechRecognition) {
            document.querySelectorAll('.mic-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    if (activeMicButton === btn) { // If this mic is active, stop it
                        if (recognition) {
                            recognition.stop();
                        }
                        return;
                    }

                    // If another mic is active, stop it first
                    if (recognition) {
                        recognition.stop();
                    }
                    
                    recognition = new SpeechRecognition();
                    recognition.continuous = true;
                    recognition.lang = 'fa-IR';
                    recognition.interimResults = true;

                    const targetId = btn.dataset.target;
                    const targetTextarea = document.getElementById(targetId);
                    let originalText = targetTextarea.value;
                    if (originalText.length > 0 && !originalText.endsWith(' ')) {
                        originalText += ' ';
                    }

                    recognition.onstart = () => {
                        document.querySelectorAll('.mic-btn').forEach(b => b.classList.remove('recording'));
                        btn.classList.add('recording');
                        activeMicButton = btn;
                    };

                    recognition.onresult = (event) => {
                        let interim_transcript = '';
                        let final_transcript = '';
                        for (let i = event.resultIndex; i < event.results.length; ++i) {
                            if (event.results[i].isFinal) {
                                final_transcript += event.results[i][0].transcript + ' ';
                            } else {
                                interim_transcript += event.results[i][0].transcript;
                            }
                        }
                        targetTextarea.value = originalText + final_transcript + interim_transcript;
                    };
                    
                    recognition.onend = () => {
                        if (activeMicButton) {
                            activeMicButton.classList.remove('recording');
                        }
                        activeMicButton = null;
                        recognition = null;
                    };
                    
                    recognition.onerror = (event) => {
                        console.error('Speech recognition error', event.error);
                        alert(`خطا در تشخیص گفتار: ${event.error}`);
                        if (activeMicButton) {
                            activeMicButton.classList.remove('recording');
                        }
                        activeMicButton = null;
                        recognition = null;
                    };
                    
                    recognition.start();
                });
            });

        } else {
            console.warn("Speech Recognition not supported in this browser.");
            document.querySelectorAll('.mic-btn').forEach(btn => btn.style.display = 'none');
        }

        // --- Share Logic ---
        function shareTool() {
            const shareData = {
                title: 'ابزار هوشمند بازمهندسی فرآیند',
                text: 'این ابزار هوشمند را برای تحلیل و بازمهندسی فرآیندهای خود بررسی کنید.',
                url: window.location.href
            };
            if (navigator.share) {
                navigator.share(shareData).catch(console.error);
            } else {
                alert('مرورگر شما از قابلیت اشتراک‌گذاری پشتیبانی نمی‌کند. می‌توانید لینک صفحه را کپی کنید.');
            }
        }
        shareToolLoginBtn.addEventListener('click', shareTool);
        shareToolMainBtn.addEventListener('click', shareTool);

        // --- Help Modal Logic ---
        helpBtn.addEventListener('click', () => {
            helpModal.classList.remove('hidden');
        });
        closeHelpBtn.addEventListener('click', () => {
            helpModal.classList.add('hidden');
        });
        helpModal.addEventListener('click', (e) => {
            if (e.target === helpModal) {
                helpModal.classList.add('hidden');
            }
        });
        
        // Inject help content
        document.querySelector('.help-content').innerHTML = `
            <h1>راهنمای ابزار هوشمند بازمهندسی فرآیند</h1>
            <h2>۱. مقدمه و هدف</h2>
            <p>این ابزار به عنوان یک دستیار هوشمند برای تحلیل‌گران و مدیران حوزه بازمهندسی فرآیند (BPR) طراحی شده است. هدف اصلی آن، خودکارسازی فرآیند تحلیل اطلاعات کیفی (مانند شناسنامه فرآیند، متن جلسات و نظرات متخصصین) و تبدیل آن‌ها به گزارش‌های ساختاریافته و استاندارد مدیریتی است. این کار باعث افزایش چشمگیر سرعت و دقت در فاز شناخت و تحلیل بازمهندسی می‌شود.</p>
            <h2>۲. متدولوژی و منطق ابزار</h2>
            <h3>الف) جمع‌آوری اطلاعات جامع</h3>
            <p>ابزار از سه منبع اصلی برای تحلیل استفاده می‌کند:</p>
            <ul>
                <li><strong>شناسنامه فرآیند</strong>: این ورودی به عنوان سند مرجع و کلید اصلی تحلیل عمل می‌کند. هوش مصنوعی، عنوان و کد فرآیند را از این بخش استخراج کرده و سایر ورودی‌ها را با آن تطبیق می‌دهد.</li>
                <li><strong>متن جلسات</strong>: شامل گفتگوها، نظرات و ایده‌های مطرح شده در جلسات بازمهندسی.</li>
                <li><strong>تحلیل متخصصین</strong>: شامل گزارش‌ها و تحلیل‌های تکمیلی که توسط مشاوران یا متخصصین ارائه شده است.</li>
            </ul>
            <h3>ب) تحلیل هوشمند و متمرکز</h3>
            <ul>
                <li><strong>اعتبارسنجی ارتباط</strong>: ابزار قبل از هر تحلیلی، بررسی می‌کند که آیا "متن جلسات" و "تحلیل متخصصین" به فرآیند ذکر شده در "شناسنامه" مرتبط هستند یا خیر. در صورت عدم ارتباط، به کاربر هشدار داده می‌شود.</li>
                <li><strong>استخراج داده</strong>: هوش مصنوعی (مبتنی بر مدل Gemini) متن‌های ورودی را بر اساس چارچوب‌های استاندارد بازمهندسی و مولفه‌های تحلیلی تعریف شده، پردازش می‌کند.</li>
                <li><strong>تولید خروجی ساختاریافته</strong>: داده‌های استخراج شده در قالب جداول استاندارد و قابل ویرایش سازماندهی می‌شوند.</li>
            </ul>
            <h3>ج) شخصی‌سازی و گزارش‌گیری</h3>
            <ul>
                <li><strong>ویرایش دستی</strong>: تمام سلول‌های جداول خروجی قابل ویرایش هستند.</li>
                <li><strong>شخصی‌سازی فرمت</strong>: کاربر می‌تواند انتخاب کند که کدام جداول در خروجی نهایی نمایش داده شوند.</li>
                <li><strong>خروجی‌های متنوع</strong>: امکان دریافت گزارش نهایی به صورت فایل HTML، PDF و همچنین کپی کردن محتوا برای استفاده در نرم‌افزارهای دیگر وجود دارد.</li>
            </ul>
            <h2>۳. راهنمای استفاده قدم به قدم</h2>
            <ul>
                <li><strong>ورود به ابزار</strong>: نام، شماره موبایل و کد استفاده ۱۰ رقمی خود را وارد کنید. اطلاعات شما و گزارش‌هایتان به صورت امن در حافظه مرورگر شما ذخیره می‌شود.</li>
                <li><strong>ورود اطلاعات</strong>: برای هر یک از سه بخش ورودی می‌توانید متن خود را تایپ کنید، با کلیک روی آیکون میکروفون به صورت صوتی وارد کنید، یا فایل‌های متنی، Word، PDF و عکس را بارگذاری نمایید.</li>
                <li><strong>تحلیل و مشاهده نتایج</strong>: پس از تکمیل ورودی‌ها، روی دکمه "تحلیل و تکمیل گزارش بازمهندسی فرایند" کلیک کنید.</li>
                <li><strong>گزارش‌های ذخیره شده</strong>: با کلیک روی آیکون آرشیو در منوی بالا، به لیست گزارش‌هایی که قبلاً ذخیره کرده‌اید دسترسی پیدا کرده، آن‌ها را مشاهده یا حذف کنید.</li>
                <li><strong>تغییر فرمت خروجی</strong>: با کلیک روی آیکون چرخ‌دنده، می‌توانید انتخاب کنید کدام جداول در تحلیل نمایش داده شوند.</li>
                <li><strong>ذخیره گزارش در ابزار</strong>: پس از هر تحلیل، با کلیک روی این دکمه، نسخه فعلی گزارش در حافظه مرورگر شما ذخیره می‌شود.</li>
                <li><strong>گزارش نهایی</strong>: با کلیک روی این دکمه، یک صفحه جدید با قابلیت دانلود PDF و HTML باز می‌شود.</li>
                <li><strong>کپی متن گزارش</strong>: با کلیک روی این دکمه، تمام جداول با ساختار کاملشان در کلیپ‌بورد شما کپی می‌شوند.</li>
            </ul>
        `;

    </script>
</body>
</html>
